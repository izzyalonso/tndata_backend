{% extends "notifications/base.html" %}
{% load tz %}
{% load redis_metric_tags %}


{% block content %}
  {# display a redis-metrics chart of sent messages #}
  {% aggregate_history metrics %}

  <table class="object-list">
    <caption>{{ jobs|length }} Enqueued Messages</caption>
    <thead>
      <tr>
        <th>Deliver In</th>
        <th>Queued</th>
        <th>User</th>
        <th>Content</th>
        <th>Job ID</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for job, scheduled_for, message_data in jobs %}
      <tr>
        <td>
          {% with deliver_on=scheduled_for|localtime %}
            {{ deliver_on|timeuntil }}<br/>
            <small>{{ deliver_on }}</small>
          {% endwith %}
        </td>
        <td>{{ job.created_at|localtime|timesince }}</td>
        <td>
          {# Clicking the user's email shows their queue for the date #}
          {% if message_data.email %}
          <a href="{% url 'notifications:userqueue' message_data.user_id message_data.date_string %}" class="userqueue">
            {{ message_data.email }}
          </a>
          {% endif %}
        </td>
        <td>
          {{ message_data.title }} {{ message_data.message }}
          <a href="/admin/notifications/gcmmessage/{{ message_data.id }}/"
            target="_blank"><i class="fa fa-external-link-square"></i></a>
        </td>
        <td><a href="/rq/queues/0/{{ job.id }}">{{ job.id }}</a></td>
        <td>
          <form action="{% url 'notifications:cancel-job' %}" method="post">
            {% csrf_token %}
            <input type="hidden" name="job_id" value="{{ job.id }}"/>
            <button type="submit"
                    class="has-tip button tiny alert"
                    data-tooltip
                    aria-haspopup="true"
                    title="Cancel this Notification">
              <i class="fa fa-ban"></i>
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="panel clearfix">
    <form action="{% url 'notifications:cancel-jobs' %}" method="post">
      {% csrf_token %}
      <input type="submit" value="Clear Notification Queue"
        class="button alert pull-right"/>
    </form>
  </div>

  <div id="queueModal" class="reveal-modal"
       data-reveal aria-labelledby="modalTitle"
       aria-hidden="true" role="dialog">
    <h2 id="modalTitle"></h2>
    <dl>
      <dt>Total</dt><dd id="queueTotal"></dd>
      <dt>Low</dt><dd><ul id="queueLow"></ul></dd>
      <dt>Medium</dt><dd><ul id="queueMedium"></ul></dd>
      <dt>High</dt><dd><ul id="queueHigh"></ul></dd>
    </dl>
    <a class="close-reveal-modal" aria-label="Close">&#215;</a>
  </div>
{% endblock %}


{% block bodyjs %}
  {{ block.super }}
  <script type="text/javascript">

  var makeQueueList = function(items) {
    // Given an array of items, return an HTML string contining <li>-items
    var content = '';
      for(var i=0; i < items.length; i++) {
        content += '<li><a href="/rq/queues/0/' +
          items[i] + '/">' + items[i] + '</a></li>';
    }
    return content;
  }

  $(document).ready(function() {
    $(".userqueue").click(function(e) {
      e.preventDefault();
      $.get($(this).prop('href'), function(data) {
        console.log(data);
        if(data) {
          $("#modalTitle").text(data.user + " " + data.date);
          $("#queueTotal").text(data.count);
          $("#queueLow").html(makeQueueList(data.low));
          $("#queueMedium").html(makeQueueList(data.medium));
          $("#queueMedium").html(makeQueueList(data.high));
          $('#queueModal').foundation('reveal', 'open');
        }
      });
    });
  });
  </script>

{% endblock %}
