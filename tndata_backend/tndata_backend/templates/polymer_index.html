{% load static from staticfiles %}
<!DOCTYPE html>
<html>
<head>
<title>Demo</title>
<meta name="viewport"
      content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
<script src="{% static "bower_components/webcomponentsjs/webcomponents.min.js" %}"></script>
<link rel="import" href="{% static "bower_components/core-icons/core-icons.html" %}">
<link rel="import" href="{% static "bower_components/core-ajax/core-ajax.html" %}">
<link rel="import" href="{% static "bower_components/core-animated-pages/core-animated-pages.html" %}">
<link rel="import" href="{% static "bower_components/core-animated-pages/transitions/slide-from-right.html" %}">
<link rel="import" href="{% static "bower_components/core-toolbar/core-toolbar.html" %}">
<link rel="import" href="{% static "bower_components/core-scaffold/core-scaffold.html" %}">
<link rel="import" href="{% static "bower_components/core-header-panel/core-header-panel.html" %}">
<link rel="import" href="{% static "bower_components/paper-icon-button/paper-icon-button.html" %}">
<link rel="import" href="{% static "bower_components/core-menu/core-menu.html" %}">
<link rel="import" href="{% static "bower_components/core-item/core-item.html" %}">
<link rel="import" href="{% static "bower_components/paper-item/paper-item.html" %}">
<link rel="import" href="{% static "bower_components/paper-shadow/paper-shadow.html" %}">
<link rel="import" href="{% static "bower_components/flatiron-director/flatiron-director.html" %}">

<!--<link rel="import" href="elements/diary-survey.html">-->
<!--<link rel="import" href="elements/login-element.html">-->

<style>
body {font-family: "RobotoDraft";font-weight: 300;}
core-animated-pages {
  width: 85%;
  height: 85%;
  -webkit-user-select: none;
  overflow: hidden;
}
core-animated-pages > * {
  border-radius: 5px;
  font-size: 50px;
  background-color: white;
}
body /deep/ core-toolbar {background-color: #03a9f4;color: #fff;}
core-menu {color: #01579b;margin: 10px 0 0 0;}
core-menu > paper-item {transition: all 300ms ease-in-out;}
paper-item a {text-decoration: none;color: currentcolor;margin-left: 5px;}
core-menu > paper-item.core-selected {background: #e1f5fe;}
@media all and (max-width: 480px) {
  core-animated-pages {
    width: 100%;
    height: 100%;
  }
}
</style>
</head>
<body unresolved fullbleed>
  {% verbatim %}
  <template is="auto-binding" id="t"> <!-- to get data-binding outside of a polymer element -->
    <flatiron-director route="{{route}}" autoHash></flatiron-director>
    <core-ajax id="ajax" auto url="{{selectedPage.page.url}}"
           handleAs="json" on-core-response="{{onResponse}}">
    </core-ajax>

    <core-scaffold id="scaffold" hidden?="{{!user}}">
      <!-- The app drawer is created by <nav> or a `navigation` attribute -->
      <nav>
        <core-toolbar><span>Menu</span></core-toolbar>
        <core-menu id="menu" valueattr="hash"
                   selected="{{route}}"
                   selectedModel="{{selectedPage}}"
                   on-core-select="{{menuItemSelected}}"
                   on-click="{{ajaxLoad}}">

          <template repeat="{{page,i in pages}}">
            <paper-item hash="{{page.hash}}" noink>
              <core-icon icon="{{page.icon}}"></core-icon>
              <a href="#{{page.url}}">{{page.name}}</a>
            </paper-item>
          </template>
        </core-menu>
      </nav>

      <!-- The Toolbar -->
      <core-toolbar tool flex> <!-- flex == span across top -->
        <div flex>{{selectedPage.page.name}}</div>
        <core-icon-button icon="refresh"></core-icon-button>
        <core-icon-button icon="add"></core-icon-button>
      </core-toolbar>
      </nav>

      <!-- Main Content Area: All other children -->
      <div layout horizontal center-center fit>
        <!--<login-element id="login" name="login" user="{{user}}" hidden?="{{user}}"></login-element>-->
        <core-animated-pages id="pages"
                             valueattr="hash"
                             hidden?="{{!user}}"
                             selected="{{route}}"
                             transitions="slide-from-right">

          <!-- TODO: how to include different elements based on the route?  -->
          <template repeat="{{page, i in pages}}">
            <section hash="{{page.hash}}" layout vertical center-center>
              <div>loading...{{route}} for {{page.name}}</div>
              <!--<diary-survey username="brad"></diary>-->
            </section>
          </template>
        </core-animated-pages>
      </div>
    </core-scaffold>
  </template>
  {% endverbatim %}

  <script>
  var DEFAULT_ROUTE = "diary";
  var ajax, pages, scaffold;
  var cache = {};
  var template = document.querySelector('#t');

  template.pages = [
    {name: 'Diary', hash: 'diary', icon: 'book', url: '/api/diary/entries/'},
    {name: 'Profile', hash: 'profile', icon: 'perm-identity', url: '/api/users/'},
  ];

  template.addEventListener('template-bound', function(e) {
    scaffold = document.querySelector("#scaffold");
    ajax = document.querySelector("#ajax");
    pages = document.querySelector("#pages");

    this.route = this.route || DEFAULT_ROUTE;
  });

  template.menuItemSelected = function(e, detail, sender) {
    if(detail.isSelected) {
      // Need to wait one rAF so ,core-ajax> has it's URL set
      this.async(function() {
        /*
        if(!cache[ajax.url]) {
          ajax.go();
        }
        */
        ajax.go();
        scaffold.closeDrawer();
      });
    }
  };

  template.ajaxLoad = function(e, detail, sender) {
    e.preventDefault(); // prevent link navigation
  };

  template.onResponse = function(e, detail, sender) {
    console.log("---> e: ", e);
    console.log("---> detail: ", detail);
    console.log("---> sender: ", sender);

    if(detail.response && detail.response.count > 0) {
      var content = "";

      for(var i=0; i < detail.response.count; i++) {
        obj = detail.response.results[i];
        if(obj.username) {
          // it's user object
          content = "<p>" + obj.username + ", " + obj.email + "</p>";
        }else if(obj.notes) {
          content = "<p>" + obj.rank + ") " + obj.notes +
                    "<br/>Saved on: " + obj.submitted_on  + "</p>";
        }
      }
    }

    var pages = document.querySelector('#pages');
    this.injectBoundHTML(content, pages.selectedItem.firstElementChild);
  };

  /* Using flatiron-director for routing. It's based on:
   *
   *  https://github.com/flatiron/director
   *
   * Two alternatives for more feature-rich routing are:
   *
   *  - https://github.com/polymore/more-routing
   *  - https://github.com/erikringsmuth/app-router
   */
  </script>
</body>
</html>
